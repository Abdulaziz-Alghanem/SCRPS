


```{r}

library(INLA)
library(MASS)
source("SCRPS.R")
data(cement)

print(cement)


result <- inla(y ~ x1 + x2 + x3 + x4, data = cement, control.compute=list(return.marginals.predictor=TRUE))
summary(result)

 print(result$summary.fitted.values)
# print(result$summary.linear.predictor)
# print(result$summary.fixed)
# print(result$summary.hyperpar)
# print(result$marginals.fitted.values)

# SCRPS_LR2 <- function(inla_result) {
# 
#   for (i in 1:nrow(inla_result$summary.fitted.values)) {
# 
#   min_mu <- inla_result$marginals.fitted.values[[i]][1,"x"]
#   max_mu <- inla_result$marginals.fitted.values[[i]][nrow(inla_result$marginals.fitted.values[[i]]),"x"]
# 
#   mu_dens <- function(x){
#     dens <- sapply(x, function(z){
#       if(z<min_mu){
#         return(0)
#       } else if (z>max_mu){
#         return(0)
#       } else{
#         return(approx(inla_result$marginals.fitted.values[[i]][,"x"], inla_result$marginals.fitted.values[[i]][,"y"], z)$y)
# 
#       }
#     })
#     return(dens)
#   }
# 
# 
#   print(mu_dens(80))
#     }
# 
# 
# 
# 
# 
# 
# }

# print(result$summary.fitted.values$mean)

SCRPS_LR <- function(inla_result, observations, n= 100000) {
  score <- observations
  for (i in 1:nrow(inla_result$summary.fitted.values)) {
    
    eta_sample <- inla.rmarginal(n, inla_result$marginals.fitted.values[[i]]) 
    score[i] = mean(SCRPS_norm(observations[i], mean = eta_sample, sd = 1/sqrt(inla_result$summary.hyperpar$mean)))
    
  }
  

  return(mean(score))
  
  
}




SCRPS_LR(result,cement$y)




SCRPS_LR_test <- function(inla_result, n= 100000) {
  score <- inla_result$.args$data$y
  for (i in 1:nrow(inla_result$summary.fitted.values)) {
    
    eta_sample <- inla.rmarginal(n, inla_result$marginals.fitted.values[[i]]) 
    temp <- SCRPS_norm(inla_result$.args$data$y[i], mean = eta_sample, sd = 1/sqrt(inla_result$summary.hyperpar$mean))
    print(var(temp))
    score[i] = mean(temp)
    
  }
  
  
  return(mean(score))
  
  
}




#SCRPS_LR_test(result)








SCRPS_LR_better <- function(inla_result, n= 10000) {
  score <- inla_result$.args$data$y
  for (i in 1:nrow(inla_result$summary.fitted.values)) {
    
    eta_sample <- inla.rmarginal(n, inla_result$marginals.fitted.values[[i]]) 
    theta_sample <- inla.rmarginal(n,inla_result$marginals.hyperpar[[1]])
    temp <- SCRPS_norm(inla_result$.args$data$y[i], mean = eta_sample, sd = 1/sqrt(theta_sample))
    print(var(temp))
    score[i] = mean(temp)
    
  }
  
  print(score)

  return(mean(score))
  
  
}

#SCRPS_LR_better(result)








SCRPS_LR_mc <- function(inla_result, n= 1000) {
  score <- inla_result$.args$data$y
  for (i in 1:nrow(inla_result$summary.fitted.values)) {
    
    eta_sample1 <- inla.rmarginal(n, inla_result$marginals.fitted.values[[i]]) 
    eta_sample2 <- inla.rmarginal(n, inla_result$marginals.fitted.values[[i]]) 
    theta_sample1 <- inla.rmarginal(n,inla_result$marginals.hyperpar[[1]])
    theta_sample2 <- inla.rmarginal(n,inla_result$marginals.hyperpar[[1]])
    # y_sample1 <- rnorm(n, mean = eta_sample1, sd = 1/sqrt(theta_sample1))
    # y_sample2 <- rnorm(n, mean = eta_sample2, sd = 1/sqrt(theta_sample2))
    y_sample1 <- numeric(0)
    y_sample2 <- numeric(0)
    for (j in 1:n) {
      temp1 <- rnorm(n, mean = eta_sample1[j], sd = 1/sqrt(theta_sample1[j]))
      temp2 <- rnorm(n, mean = eta_sample2[j], sd = 1/sqrt(theta_sample2[j]))
      y_sample1 <- c(y_sample1, temp1)
      y_sample2 <- c(y_sample2, temp2)
      
      
    }
    
    y <- inla_result$.args$data$y[i]
    E1 <- mean(abs(y_sample1-y))
    E2 <- mean(abs(y_sample1-y_sample2))
    score[i] = -E1/E2 - 0.5*log(E2)
    
  }
  
 print(score)
  return(mean(score))
  
  
}

#SCRPS_LR_mc(result)





SCRPS_LR_better_test <- function(inla_result, n= 1000000) {
  score <- inla_result$.args$data$y
  for (i in 1:nrow(inla_result$summary.fitted.values)) {

    score[i] = SCRPS_norm(inla_result$.args$data$y[i], mean = inla_result$summary.fitted.values$mean[i], sd = sqrt( inla_result$summary.fitted.values$sd[i]^2 + 1/(inla_result$summary.hyperpar$mean)) )
    
  }
  
  print(score)

  return(mean(score))
  
  
}

SCRPS_LR_better_test(result)











SCRPS_LR_better_test2 <- function(inla_result, n= 1000) {
  score <- inla_result$.args$data$y
  for (i in 1:nrow(inla_result$summary.fitted.values)) {
    
    eta_sample1 <- inla.rmarginal(n, inla_result$marginals.fitted.values[[i]]) 
    eta_sample2 <- inla.rmarginal(n, inla_result$marginals.fitted.values[[i]]) 
    y_sample1 <- numeric(0)
    y_sample2 <- numeric(0)
    for (j in 1:n) {
      temp1 <- rnorm(n, mean = eta_sample1[j], sd = 1/sqrt(inla_result$summary.hyperpar$mean))
      temp2 <- rnorm(n, mean = eta_sample2[j], sd = 1/sqrt(inla_result$summary.hyperpar$mean))
      y_sample1 <- c(y_sample1, temp1)
      y_sample2 <- c(y_sample2, temp2)
      
      
    }
    
    y <- inla_result$.args$data$y[i]
    E1 <- mean(abs(y_sample1-y))
    E2 <- mean(abs(y_sample1-y_sample2))
    score[i] = -E1/E2 - 0.5*log(E2)
    
  }
  
 print(score)
  return(mean(score))
  
  
}

SCRPS_LR_better_test2(result)







SCRPS_LR_better <- function(inla_result, n= 1) {
  score <- inla_result$.args$data$y
  for (i in 1:nrow(inla_result$summary.fitted.values)) {
    temp <- SCRPS_norm(inla_result$.args$data$y[i], mean = inla_result$summary.fitted.values$mean[i], sd = 1/sqrt(inla_result$summary.hyperpar$mean))
    score[i] = mean(temp)
    
  }
  
  print(score)

  return(mean(score))
  
  
}

SCRPS_LR_better(result)












# ###############################
numeric_Int_test <- function(inla_result, Step_size = 0.001) {
#   
  score <- inla_result$.args$data$y


   for (i in 1:nrow(inla_result$summary.fitted.values)) {

    min_mu <- inla_result$marginals.fitted.values[[i]][1,"x"]
    max_mu <- inla_result$marginals.fitted.values[[i]][nrow(inla_result$marginals.fitted.values[[i]]),"x"]

    mu_dens <- function(x){
    dens <- sapply(x, function(z){
      if(z<min_mu){
        return(0)
      } else if (z>max_mu){
        return(0)
      } else{
        return(approx(x=inla_result$marginals.fitted.values[[i]][,"x"], y=inla_result$marginals.fitted.values[[i]][,"y"], xout=z)$y)

      }
    })
    return(dens)
  }


    min_theta <- inla_result$marginals.hyperpar[[1]][1,"x"]
    max_theta <- inla_result$marginals.hyperpar[[1]][nrow(inla_result$marginals.hyperpar[[1]]),"x"]

    theta_dens <- function(x){
    dens <- sapply(x, function(z){
      if(z<min_theta){
        return(0)
      } else if (z>max_theta){
        return(0)
      } else{
        return(approx(inla_result$marginals.hyperpar[[1]][,"x"], inla_result$marginals.hyperpar[[1]][,"y"], z)$y)

      }
    })
    return(dens)
  }


    temp_func <- function(mu, theta) {

      return(SCRPS_norm(inla_result$.args$data$y[i], mean = mu, sd = 1/sqrt(theta))*mu_dens(mu)*theta_dens(theta))


    }
  

  
  
      
    theta_grid <- seq(from = min_theta, to = max_theta, by = Step_size)
    
    Integral1 = numeric(length=length(theta_grid))

    for(j in 1:length(theta_grid)){
          Integral1[j] <- integrate(f = temp_func, lower = min_mu, upper = max_mu, theta=theta_grid[j])[[1]]
    }
    
    
    temp_func2 <- function(x){
    dens <- sapply(x, function(z){
      if(z<theta_grid[1]){
        return(0)
      } else if (z>theta_grid[length(theta_grid)]){
        return(0)
      } else{
        return(approx(x=theta_grid, y=Integral1, xout=z)$y)

      }
    })
    return(dens)
  }


    
        Integral2 = integrate(f = temp_func2, lower = min_theta, upper = max_theta)[[1]]
    score[i]  = Integral2
  }




  print(score)

  return(mean(score))






}


numeric_Int_test(result)
```
